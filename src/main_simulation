% =========================================================================
% MAIN SIMULATION: 6G Microgrid Slicing (With Physics/Channel Model)
% NAME:Bernard Kobina Forson Essel
% =========================================================================

clc; clear; close all;

%% 1. Load System Parameters
System = config_parameters(); 

% Simulation Settings
Sim_Duration_ms = 100;         
Total_TTIs = Sim_Duration_ms / (System.TTI * 1000); 

%% 2. Initialize Storage
Queue.URLLC = []; 
Queue.mMTC  = [];

Results.Latency = [];
Results.Throughput_URLLC = zeros(1, Total_TTIs);
Results.Throughput_mMTC  = zeros(1, Total_TTIs);
Results.Grid_Status_Log  = zeros(1, Total_TTIs);
Results.Packet_Errors    = 0; % Track physics failures

current_time = 0;

disp('Starting Simulation with Channel Physics...');

%% 3. Main Time Loop
for t = 1:Total_TTIs
    
    current_time = current_time + System.TTI;
    
    % --- A. Generate Traffic & Assign Distances ---
    
    % URLLC (Protection Relays - Usually static/close)
    if rand() > 0.8  
        new_pkt.Size = System.Slice_URLLC.PacketSize;
        new_pkt.ArrivalTime = current_time;
        new_pkt.Distance = 50 + (rand() * 100); % 50m to 150m (Critical devices are closer)
        Queue.URLLC = [Queue.URLLC, new_pkt]; 
    end
    
    % mMTC (Smart Meters - Can be far away)
    if rand() > 0.2  
        new_pkt.Size = System.Slice_mMTC.PacketSize;
        new_pkt.ArrivalTime = current_time;
        new_pkt.Distance = 10 + (rand() * 490); % 10m to 500m (Spread out)
        Queue.mMTC = [Queue.mMTC, new_pkt];
    end
    
    % --- B. Simulate Fault Scenario ---
    if current_time > 0.040 && current_time < 0.060
        Grid_Status = 1; % FAULT
    else
        Grid_Status = 0; % NORMAL
    end
    Results.Grid_Status_Log(t) = Grid_Status;

    % --- C. Call The Scheduler ---
    [Stats, Updated_Queue] = scheduler_logic(Queue, System, Grid_Status, current_time);
    
    % --- D. The Physics Check (NEW SECTION) ---
    % We must check if the "Sent" packets actually survived the channel.
    % Note: In a real discrete sim, we would check each packet. 
    % Here we approximate the Bit Error Rate (BER) for the batch.
    
    % Calculate Physics for URLLC this TTI (if any sent)
    Bits_Sent_URLLC = Stats.URLLC_Sent * System.Slice_URLLC.PacketSize;
    if Stats.URLLC_Sent > 0
        % Calculate SNR for a typical device distance in this batch
        avg_dist = 100; % Simplified for batch
        [SNR, ~] = channel_model(avg_dist, System);
        
        % Simple threshold: If SNR < 10dB, packet is corrupted
        if SNR < 10
             Bits_Sent_URLLC = 0; % All lost to noise
             Results.Packet_Errors = Results.Packet_Errors + Stats.URLLC_Sent;
        end
    end
    
    % --- E. Update Results ---
    Queue = Updated_Queue; 
    Results.Throughput_URLLC(t) = Bits_Sent_URLLC; 
    Results.Throughput_mMTC(t)  = Stats.mMTC_Sent * System.Slice_mMTC.PacketSize;
    
    if ~isempty(Stats.URLLC_Latency)
        Results.Latency = [Results.Latency, Stats.URLLC_Latency];
    end
end

disp(['Simulation Complete. Total Physics Errors: ', num2str(Results.Packet_Errors)]);

%% 4. Visualization
figure('Name', 'Performance Analysis of Dynamic Slicing under Fault Conditions');

% Plot 1: Scenario
subplot(3,1,1);
time_axis = (1:Total_TTIs) * System.TTI * 1000; 
area(time_axis, Results.Grid_Status_Log, 'FaceColor', 'r', 'FaceAlpha', 0.3);
title('Fig. 1a: Temporal Analysis of Microgrid Operational States'); 
ylabel('State (1=Fault)'); xlabel('Simulation Time (ms)');

% Plot 2: Throughput
subplot(3,1,2);
plot(time_axis, Results.Throughput_URLLC, 'r', 'LineWidth', 1.5); hold on;
plot(time_axis, Results.Throughput_mMTC, 'b--', 'LineWidth', 1);
legend('URLLC (Protection)', 'mMTC (Meters)', 'Location', 'best');
title('Fig. 1b: Dynamic Resource Allocation (Post-Channel Check)'); 
ylabel('Throughput (bits/TTI)');

% Plot 3: Latency
subplot(3,1,3);
if ~isempty(Results.Latency)
    h = cdfplot(Results.Latency * 1000); 
    set(h, 'LineWidth', 2); 
    title('Fig. 1c: CDF of Protection Slice Latency'); 
    xlabel('End-to-End Latency (ms)');
else
    text(0.5,0.5,'No URLLC Packets Sent');
end
